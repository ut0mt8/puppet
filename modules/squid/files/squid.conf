# PUPPET #
http_port 3128
icp_port 0
visible_hostname proxy-01

cache_effective_user proxy

append_domain .compagny.fr

coredump_dir /var/spool/squid
cache_store_log none
access_log /var/log/squid/access.log squid
access_log none
error_directory  /usr/share/squid/errors/French

acl QUERY urlpath_regex cgi-bin \? .asp .jsp
acl no-cache-domain dstdomain "/etc/squid/no-cache-domain.txt"
acl no-cache-regex dstdom_regex -i "/etc/squid/no-cache-regex.txt"
no_cache deny QUERY
no_cache deny no-cache-domain
no_cache deny no-cache-regex

auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp
auth_param ntlm children 5 

auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic
auth_param basic children 2 
auth_param basic realm 'Entrer votre login sous la forme GCFR\login'
auth_param basic credentialsttl 2 hours

external_acl_type mysql-dst-allowed %DST /usr/lib/squid/mysql-dst-allowed

external_acl_type ldap_group ttl=3600 children=3 %LOGIN \
/usr/lib/squid/squid_ldap_group -b \
"cn=USERS,dc=COMP,dc=FR" -f \
"(&(cn=%a)(member=%v)(objectClass=group))" -F "(|(samAccountName=%s)(cn=%s))" \
-h gcdc-01.compagny.fr \
-h gcdc-02.compagny.fr \
-h gcdc-03.compagny.fr \
-D ldap -w ldap01 -v3 -S


authenticate_ttl 1 hour
authenticate_ip_ttl 30 minute

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern .               0       20%     4320

cache_mem 512 MB
cache_dir ufs /var/spool/squid 20000 16 256


redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
redirect_children 5

acl all src 0.0.0.0/0.0.0.0
acl manager proto cache_object
acl localhost src 127.0.0.1/255.255.255.255
acl to_localhost dst 127.0.0.0/8
acl SSL_ports port 443 8181 8444
acl Safe_ports port 20 21 22 80 81 83 8080 8181 9080 443 8444 8888
acl CONNECT method CONNECT

acl lunch-time time MTWHF 12:30-14:00 
acl lunch-time2 time MTWHF 18:00-23:59
acl lunch-time3 time MTWHF 00:00-07:00

acl authentified proxy_auth REQUIRED

acl site src "/etc/squid/site-network.txt"
acl paritel-networks dst 192.168.0.0/255.255.0.0

acl src-allowed-direct src "/etc/squid/src-allowed-direct.txt"
acl src-allowed-proxy  src "/etc/squid/src-allowed-proxy.txt"

acl dst-allowed external mysql-dst-allowed

acl dst-unallowed-domain dstdomain -i "/etc/squid/dst-unallowed-domain.txt"
acl dst-unallowed-regex dstdom_regex -i "/etc/squid/dst-unallowed-regex.txt"
acl dst-unallowed-host dst "/etc/squid/dst-unallowed-host.txt"

acl dst-no-socialnetwork dstdom_regex -i "/etc/squid/dst-no-socialnetwork.txt"
acl dst-no-streaming dstdom_regex -i "/etc/squid/dst-no-streaming.txt"

acl restricted-users external ldap_group Squid_restricted
acl full-users external ldap_group Squid_full
acl semi-full-users external ldap_group Squid_semi-full
acl lunchtime-users external ldap_group Squid_lunchtime
acl instancemultiple external ldap_group Squid_instancemultiple
acl no-socialnetwork-users external ldap_group Squid_no_streaming
acl no-streaming-users external ldap_group Squid_no_socialnetwork

acl slow-domains url_regex -i "/etc/squid/slow-domains.txt"

delay_pools 2

delay_class 1 1
delay_parameters 1 8000/8000
delay_access 1 allow slow-domains !full-users

delay_class 2 1
delay_parameters 2 1048576/1048576
delay_access 2 allow all

acl maxusers max_user_ip -s 1
acl max-instancemultiple max_user_ip -s 25 


#acl whitelist-host      src "/etc/squid/whitelist-host.txt"

acl no-auth-host        src "/etc/squid/no-auth-host.txt"
acl no-auth-domain      dstdomain "/etc/squid/no-auth-domain.txt"
acl no-auth-dstip       dst "/etc/squid/no-auth-dstip.txt"

#acl launchtime-allowed proxy_auth -i "/etc/squid/launchtime-allowed.txt"

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow localhost
http_access allow site paritel-networks
#http_access allow whitelist-host
http_access allow no-auth-host no-auth-domain
http_access allow no-auth-host no-auth-dstip
http_access deny !authentified
deny_info ERR_NOT_AUTHENTIFIED authentified

http_access deny !instancemultiple maxusers
deny_info ERR_MAXUSERS maxusers
http_access deny  max-instancemultiple

http_access allow lunchtime-users lunch-time
http_access allow lunchtime-users lunch-time2
http_access allow lunchtime-users lunch-time3

http_access deny restricted-users !dst-allowed
deny_info ERR_RESTRICTED dst-allowed
http_access allow restricted-users

http_access deny no-streaming-users dst-no-streaming
http_access deny no-socialnetwork-users dst-no-socialnetwork
 

http_access deny semi-full-users dst-unallowed-domain
http_access deny semi-full-users dst-unallowed-regex
http_access deny semi-full-users dst-unallowed-host
#http_access allow semi-full-users

http_access allow full-users

http_access allow semi-full-users

#http_access allow no-streaming-users
#http_access allow no-socialnetwork-users

http_access deny all
deny_info ERR_NO_GROUP all
http_reply_access allow all

# always_direct allow site paritel-networks
# never_direct deny site paritel-networks
                                                   
